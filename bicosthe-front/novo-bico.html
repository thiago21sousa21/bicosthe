<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Serviço</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <h1>Cadastro de Serviço</h1>

  <form id="servicoForm">

    <label>Valor: <input type="number" step="0.01" name="valor" required></label><br><br>

    <label>Título: <input type="text" name="titulo" maxlength="100" required></label><br><br>

    <label>Descrição:<br>
      <textarea name="descricao" maxlength="1000" rows="4" cols="50" required></textarea>
    </label><br><br>

    <label>Data de Início: <input type="datetime-local" name="dataInicio" required></label><br><br>

    <label>Data de Fim: <input type="datetime-local" name="dataFim" required></label><br><br>

    <label>ID da Região: <input type="number" name="idregiao" required></label><br><br>

    <label>ID do Usuário: <input type="number" name="usuarioId" required></label><br><br>

    <label>Contato Visível: <input type="checkbox" name="contato_visivel"></label><br><br>

    <label>Categorias (IDs separados por vírgula):<br>
      <input type="text" name="categorias" placeholder="Ex: 1,2,3" required>
    </label><br><br>

    <button type="submit">Cadastrar</button>
  </form>

  <div id="resposta" style="margin-top: 20px; font-weight: bold;"></div>

  <script>
    const token = localStorage.getItem('token');
    const idusuario = localStorage.getItem('idusuario');

    if (!token || !idusuario) {
      // Se não estiver logado, redireciona para a página de login
      window.location.href = 'login.html';
    }

    function formatDateToMySQL(datetimeStr) {
        //essa função aqui está recebendo uma data como paratro e mudando o formato original que era iso (ex: 2024-10-26T17:30:00) para
        //o formato AAAA-MM-DD HH:MM:SS por que o banco de dados esta esperando nesse formato
        const date = new Date(datetimeStr);
        const pad = (n) => n.toString().padStart(2, '0');

        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        const seconds = pad(date.getSeconds());

        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    document.getElementById('servicoForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const form = e.target;

    const data = {
        // aqui esta sendo criado um objeto (no python seria um dicionario) esse objeto vai ser enviado ele tem os campos titulo, valor...
        valor: parseFloat(form.valor.value),
        titulo: form.titulo.value,
        descricao: form.descricao.value,
        dataInicio: formatDateToMySQL(form.dataInicio.value),
        dataFim: formatDateToMySQL(form.dataFim.value),
        idregiao: parseInt(form.idregiao.value),
        usuarioId: parseInt(localStorage.getItem('idusuario')),
        contato_visivel: form.contato_visivel.checked,
        categorias: form.categorias.value.split(',').map(id => parseInt(id.trim()))
    };

    try {
        const res = await axios.post('http://localhost:5000/novo-bico', data, {
        headers: {
            Authorization: `Bearer ${token}`
        }
        });

        document.getElementById('resposta').innerText = '✅ Serviço cadastrado com sucesso!';
        form.reset();
    } catch (err) {
        console.error(err);
        const mensagem = err.response?.data || err.message;
        document.getElementById('resposta').innerText = '❌ Erro ao cadastrar serviço: ' + mensagem;
    }
    });

  </script>
</body>
</html>
